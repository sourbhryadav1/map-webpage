<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Share Location</title>
    <meta name="theme-color" content="#0069ff">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
      :root { --bg:#0b0e14; --card:#101623; --muted:#a0a8b8; --fg:#e6edf3; --brand:#3b82f6; --ok:#16a34a; --err:#ef4444; }
      * { box-sizing: border-box; }
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: var(--bg); color: var(--fg); }
      .wrap { max-width: 960px; margin: 0 auto; }
      .card { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03)); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(6px); border-radius: 16px; padding: 16px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      p { margin: 8px 0 16px; color: var(--muted); }
      .actions { display: grid; grid-template-columns: 1fr auto; gap: 8px; align-items: center; }
      button { background: var(--brand); color: white; border: none; padding: 12px 16px; border-radius: 10px; cursor: pointer; font-size: 16px; box-shadow: 0 6px 24px rgba(59,130,246,.35); }
      button:disabled { background: #3b82f6aa; box-shadow: none; cursor: not-allowed; }
      #map { height: 52vh; min-height: 280px; width: 100%; border-radius: 14px; margin-top: 12px; border: 1px solid rgba(255,255,255,0.08); }
      .status { margin-top: 12px; font-size: 14px; }
      .ok { color: var(--ok); }
      .err { color: var(--err); }
      .coords { margin-top: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 13px; color: var(--muted); }
      @media (min-width: 760px) { h1 { font-size: 22px; } .card { padding: 20px; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Share your location</h1>
        <p>We use your location to match you with nearby services. Your data is kept private.</p>
        <div class="actions">
          <button id="shareBtn">Share current location</button>
          <button id="copyBtn" title="Copy coordinates" disabled>Copy</button>
        </div>
        <div id="status" class="status"></div>
        <div id="coords" class="coords"></div>
        <div id="map"></div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
      const shareBtn = document.getElementById('shareBtn');
      const copyBtn = document.getElementById('copyBtn');
      const statusEl = document.getElementById('status');
      const coordsEl = document.getElementById('coords');
      let userId = null;
      let map, marker;

      function getQueryParam(name){
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      function setStatus(text, ok=false) {
        statusEl.textContent = text;
        statusEl.className = 'status ' + (ok ? 'ok' : 'err');
      }

      function setCoords(lat, lng) {
        const text = `lat: ${lat.toFixed(6)}, lng: ${lng.toFixed(6)}`;
        coordsEl.textContent = text;
        copyBtn.disabled = false;
      }

      copyBtn.addEventListener('click', () => {
        if (!coordsEl.textContent) return;
        navigator.clipboard.writeText(coordsEl.textContent);
      });

      shareBtn.addEventListener('click', async () => {
        if (!userId) return setStatus('Missing user id.', false);
        if (!navigator.geolocation) {
          setStatus('Geolocation is not supported by your browser.', false);
          return;
        }
        setStatus('Fetching location…');
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const { latitude, longitude } = pos.coords;
          setCoords(latitude, longitude);
          if (!map) initMap(latitude, longitude);
          else updateMarker(latitude, longitude);
          setStatus('Sending to server…');
          try {
            const res = await fetch('/api/location', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user_id: userId, latitude, longitude })
            });
            if (!res.ok) throw new Error('Failed to save');
            setStatus('Location saved successfully.', true);
          } catch (e) {
            setStatus('Could not save location. Please try again.', false);
          }
        }, (err) => {
          setStatus(err.message || 'Could not get location.', false);
        }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
      });

      function initMap(lat, lng) {
        map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        marker = L.marker([lat, lng]).addTo(map);
      }

      function updateMarker(lat, lng) {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng]);
      }

      // bootstrap
      (function init(){
        userId = getQueryParam('user_id');
        if (!userId) setStatus('Missing user id.', false);
        // Attempt to show approximate map using browser geolocation (no post yet)
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((pos) => {
            const { latitude, longitude } = pos.coords;
            initMap(latitude, longitude);
            setCoords(latitude, longitude);
          }, () => {
            // fallback to a default center
            initMap(28.6139, 77.2090); // Delhi
          }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 });
        } else {
          initMap(28.6139, 77.2090);
        }
      })();
    </script>
  </body>
  </html>


