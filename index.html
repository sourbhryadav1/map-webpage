<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Share Location</title>
    <meta name="theme-color" content="#0069ff">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <style>
      :root { --bg:#ffffff; --card:#ffffff; --muted:#5f6368; --fg:#0b0b0b; --brand:#2563eb; --ok:#16a34a; --err:#b00020; }
      * { box-sizing: border-box; }
      body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: var(--bg); color: var(--fg); }
      .wrap { max-width: 960px; margin: 0 auto; }
      .card { background: var(--card); border: 1px solid #eaecef; border-radius: 16px; padding: 16px; }
      h1 { margin: 0 0 6px; font-size: 20px; }
      p { margin: 8px 0 16px; color: var(--muted); }
      .actions { display: grid; grid-template-columns: 1fr; gap: 8px; align-items: center; }
      button { background: var(--brand); color: white; border: none; padding: 12px 16px; border-radius: 10px; cursor: pointer; font-size: 16px; box-shadow: 0 6px 24px rgba(59,130,246,.15); }
      button:disabled { background: #a3b6f6; box-shadow: none; cursor: not-allowed; }
      #map { height: 52vh; min-height: 280px; width: 100%; border-radius: 14px; margin-top: 12px; border: 1px solid rgba(255,255,255,0.08); }
      .status { margin-top: 12px; font-size: 14px; }
      .ok { color: var(--ok); }
      .err { color: var(--err); }
      .coords { margin-top: 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 13px; color: var(--muted); }
      @media (min-width: 760px) { h1 { font-size: 22px; } .card { padding: 20px; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Share your location</h1>
        <p>We use your location to match you with nearby services. Your data is kept private.</p>
        <div class="actions">
          <button id="shareBtn">Share current location</button>
        </div>
        <div id="status" class="status"></div>
        <div id="coords" class="coords"></div>
        <div id="map"></div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
      const shareBtn = document.getElementById('shareBtn');
      const statusEl = document.getElementById('status');
      const coordsEl = document.getElementById('coords');
      let userId = null;
      let map, marker;

      function getQueryParam(name){
        const params = new URLSearchParams(window.location.search);
        return params.get(name);
      }

      function sanitizeBase(urlStr){
        if (!urlStr) return '';
        let u = (urlStr + '').trim();
        // remove trailing slash
        if (u.endsWith('/')) u = u.slice(0, -1);
        return u;
      }

      function setStatus(text, ok=false) {
        statusEl.textContent = text;
        statusEl.className = 'status ' + (ok ? 'ok' : 'err');
      }

      function setCoords(lat, lng) {
        const text = `lat: ${lat.toFixed(6)}, lng: ${lng.toFixed(6)}`;
        coordsEl.textContent = text;
      }

      shareBtn.addEventListener('click', async () => {
        if (!userId) return setStatus('Missing user id.', false);
        if (!navigator.geolocation) {
          setStatus('Geolocation is not supported by your browser.', false);
          return;
        }
        setStatus('Fetching location…');
        navigator.geolocation.getCurrentPosition(async (pos) => {
          const { latitude, longitude } = pos.coords;
          setCoords(latitude, longitude);
          if (!map) initMap(latitude, longitude);
          else updateMarker(latitude, longitude);
          setStatus('Sending to server…');
          try {
            const apiBase = sanitizeBase(getQueryParam('backend'));
            const postUrl = (apiBase ? apiBase : '') + '/api/location';
            const res = await fetch(postUrl || '/api/location', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ user_id: userId, latitude, longitude })
            });
            if (!res.ok) {
              const text = await res.text().catch(() => '');
              throw new Error(`Failed (${res.status}) ${text}`);
            }
            const data = await res.json().catch(() => ({}));
            setStatus('Location saved successfully.', true);
            console.log('Saved OK', { postUrl, data });
          } catch (e) {
            console.error('Save error', e);
            setStatus(`Could not save location. ${e && e.message ? e.message : ''}`, false);
          }
        }, (err) => {
          setStatus(err.message || 'Could not get location.', false);
        }, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 });
      });

      function initMap(lat, lng) {
        map = L.map('map').setView([lat, lng], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        marker = L.marker([lat, lng]).addTo(map);
      }

      function updateMarker(lat, lng) {
        marker.setLatLng([lat, lng]);
        map.setView([lat, lng]);
      }

      // bootstrap
      (function init(){
        // Read according to required format: ?id=<user_id>&backend=<url>
        userId = (getQueryParam('id') || '').trim();
        if (!userId) setStatus('Missing user id.', false);
        // Attempt to show approximate map using browser geolocation (no post yet)
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition((pos) => {
            const { latitude, longitude } = pos.coords;
            initMap(latitude, longitude);
            setCoords(latitude, longitude);
          }, () => {
            // fallback to a default center
            initMap(28.6139, 77.2090); // Delhi
          }, { enableHighAccuracy: true, timeout: 8000, maximumAge: 60000 });
        } else {
          initMap(28.6139, 77.2090);
        }
      })();
    </script>
  </body>
  </html>


